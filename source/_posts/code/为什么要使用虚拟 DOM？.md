---
title: 为什么要使用虚拟 DOM？
categories:
  - Code
tags:
  - 原理
abbrlink: 59417
date: 2017-10-02 17:00:14
updated: 2021-10-03 01:28:44
---

有一天，一个朋友问了我一个 React 问题，“组件化、单向数据绑定，这些我都明白，但为什么要使用虚拟 DOM 呢?”

我给了他一个惯常的回答，“因为直接操作 DOM 操作效率低，速度慢。”

他继续追问，“那是什么让直接向 DOM 更新变得缓慢?”

于是引出了本篇文章的主题：**为什么要使用虚拟 DOM？**

为了理解虚拟 DOM，将从浏览器的工作流程开始讲起，以及探究 DOM 更改后到底发生了什么。

## 浏览器的引擎工作流程

下面的图表和相应的解释使用了 Webkit 引擎的工作原理。

![A Browser’s Workflow.png](https://www.jojoer.com/upload/2021/10/A%20Browser%E2%80%99s%20Workflow-530acdd7f1184747b591b6fe2a475ac7.png)

除了一些细微差别外，所有浏览器的工作流程几乎都是相似的，如上图大致分 5 步：创建 DOM tree –> 创建 Style Rules -> 构建 Render tree -> 布局 Layout –> 绘制 Painting。

第一步，用 HTML 分析器，分析 HTML 元素，构建 DOM 树。

第二步：用 CSS 分析器，分析 CSS 文件和元素上的 inline 样式，生成页面的样式表。

第三步：将上面的 DOM 树和样式表关联起来，构建 Render 树。这一过程又称为 Attachment。每个 DOM 节点都有 attach 方法，接受样式信息，返回一个 render 对象（又名 renderer）。这些 render 对象最终会被构建成 Render 树。

第四步：有了 Render 树后，浏览器开始布局，会为每个 Render 树上的节点确定一个在显示屏上出现的精确坐标值。

第五步：最后就是调用每个节点的 paint 方法，让它们显示出来。

## 走进虚拟 DOM

当使用传统的原生 api 或 jQuery 去操作 DOM 时，浏览器会从构建 DOM 树开始从头到尾执行一遍流程。

DOM 操作的真正问题是，每个操作都有可能触发布局更改、树修改和渲染。假设你一个接一个地修改了 30 个节点。这意味着 30 个节点都可能重新计算布局和重新渲染。

理想状态是一次性构建完 DOM 树，再执行后续操作。

> 其实，这种特定行为也可以在没有虚拟 DOM 的情况下得到优化。比如手动将所有 DOM 修改分组到一个 DOM 片段中，然后将其添加到 DOM 中。

即使计算机硬件一直在更新迭代，操作 DOM 的代价仍旧是昂贵的，频繁操作还是会出现页面卡顿，影响用户的体验。真实的 DOM 节点，哪怕一个最简单的 div 也包含着很多属性，可以打印出来直观感受一下：

![Div Property.webp](https://www.jojoer.com/upload/2021/10/Div%20Property-0e5d216a6925464983f7071692453b3a.webp)

那么，虚拟 DOM 解决了什么问题呢?

虚拟 DOM 是为了解决如上浏览器性能问题而被设计出来的。例如前面的例子，假如一次操作中有 30 次更新 DOM 的动作，虚拟 DOM 不会立即操作 DOM，而是将这 30 次更新的 diff 内容保存到本地的一个 JS 对象中，最终将这个 JS 对象一次性 attach 到 DOM 树上，通知浏览器去执行绘制工作，这样可以避免大量的无谓的计算量。

它自动化并抽象了 DOM 树的管理，从而免除了手动操作。不仅如此，它还跟踪了哪些部分已经更改，哪些没有更改，知道哪些部分需要刷新，哪些部分不需要刷新。

最后，通过放弃对自身的 DOM 操作，它允许不同的组件或代码片段请求 DOM 修改，而不需要它们之间进行交互，也不需要共享它们已经修改或想要修改 DOM 的状态和事件。这意味着它提供了一种方法，可以避免在修改 DOM 的所有部分之间进行同步，同时仍然将所有修改聚合成一次操作。

## 总结

为什么我们要引入虚拟 DOM，而不是直接将组件转换为 DOM 节点呢？

主要是为了增加灵活性和提升性能：

1. 增加灵活性，支持跨平台渲染

   在技术领域一向有增加中间层的思路，利用中间层可以提供更多的灵活性。把原先的过程拆分为标准化和渲染两步之后，标准化的虚拟 DOM 数据根据需要进行渲染就可以适应更多平台。

   虚拟 DOM 不仅可以变成 DOM，还可以变成小程序、 iOS 应用、安卓应用，因为虚拟 DOM 本质上只是一个 JS 对象。

2. 提升性能，减少 DOM 的操作

   虚拟 DOM 可以将多次操作合并为一次操作，减少 DOM 操作的次数。

   虚拟 DOM 借助 diff 算法可以把多余的操作省掉，减少 DOM 操作的范围。比如你添加 1000 个节点，其实只有 10 个是新增的。

当然虚拟 DOM 也有缺点，就是需要额外的创建函数，如 create Element 或 h，不够直观。但是可以通过 JSX 等方案来简化成 XML 的写法。
